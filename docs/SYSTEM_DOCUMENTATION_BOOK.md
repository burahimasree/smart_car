# Smart Car Voice-Controlled Robot

## Complete System Documentation & Technical Reference

**Version**: 1.0  
**Last Updated**: January 15, 2026  
**Platform**: Raspberry Pi 4 + ESP32  

---

# TABLE OF CONTENTS

1. [Executive Summary](#1-executive-summary)
2. [System Architecture](#2-system-architecture)
3. [Hardware Components](#3-hardware-components)
4. [Software Services Deep Dive](#4-software-services-deep-dive)
5. [Inter-Process Communication](#5-inter-process-communication)
6. [Runtime Flows & Sequences](#6-runtime-flows--sequences)
7. [Safety Systems](#7-safety-systems)
8. [Configuration Reference](#8-configuration-reference)
9. [Failure Analysis & Recovery](#9-failure-analysis--recovery)
10. [Known Issues & Bugs](#10-known-issues--bugs)
11. [Maintenance Guide](#11-maintenance-guide)
12. [Appendices](#12-appendices)

---

# 1. EXECUTIVE SUMMARY

## 1.1 Project Overview

The Smart Car is an autonomous voice-controlled robot built on a Raspberry Pi 4 platform with an ESP32 motor controller. It combines:

- **Voice Interface**: Wake word detection â†’ Speech-to-Text â†’ Large Language Model â†’ Text-to-Speech
- **Computer Vision**: Real-time object detection and visual servoing (object following)
- **Motor Control**: Bidirectional UART communication with dual-layer collision avoidance
- **User Feedback**: TFT display with animated face expressions and LED ring status indicators

## 1.2 Key Capabilities

| Capability | Technology | Latency |
|------------|------------|---------|
| Wake Word Detection | Porcupine (Picovoice) | ~50ms |
| Speech Recognition | faster-whisper (CTranslate2) | ~2s |
| Intent Understanding | Google Gemini 2.5 Flash | ~1-2s |
| Voice Synthesis | Piper Neural TTS | ~500ms |
| Object Detection | YOLO11n ONNX | ~66ms (15 FPS) |
| Motor Response | ESP32 UART | ~10ms |

## 1.3 System Requirements

**Hardware**:
- Raspberry Pi 4 (4GB+ RAM recommended)
- ESP32 DevKit with motor driver
- USB Microphone (16kHz capable)
- USB Speaker or 3.5mm audio
- Waveshare 3.5" TFT Display (480x320, SPI)
- 8-pixel NeoPixel Ring (WS2812B)
- USB Camera or Pi Camera Module
- Ultrasonic sensor (HC-SR04) on ESP32

**Software**:
- Raspberry Pi OS (64-bit)
- Python 3.11+
- Multiple virtual environments (see Section 8)

---

# 2. SYSTEM ARCHITECTURE

## 2.1 High-Level Architecture Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                    USER INTERACTION                                  â”‚
â”‚                                                                                      â”‚
â”‚    ğŸ¤ Voice Command          ğŸ‘ï¸ Visual Scene           ğŸ–¥ï¸ Display Feedback           â”‚
â”‚    "Hey Veera, follow       Camera sees person        Face shows LISTENING          â”‚
â”‚     that person"            at position (x,y)         LED ring spins green          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                            â”‚
                                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                                      â”‚
â”‚                              RASPBERRY PI 4 (Main Brain)                            â”‚
â”‚                                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         ORCHESTRATOR (Central Hub)                           â”‚   â”‚
â”‚  â”‚                         src/core/orchestrator.py                             â”‚   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â”‚   State Machine:                                                             â”‚   â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚   â”‚
â”‚  â”‚   â”‚  IDLE    â”‚â”€â”€â”€â–¶â”‚ LISTENING â”‚â”€â”€â”€â–¶â”‚ THINKING â”‚â”€â”€â”€â–¶â”‚ SPEAKING  â”‚            â”‚   â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚   â”‚
â”‚  â”‚        â–²                                                  â”‚                  â”‚   â”‚
â”‚  â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â”‚   Flags: vision_paused, stt_active, llm_pending, tts_pending,               â”‚   â”‚
â”‚  â”‚          tracking_target, esp_obstacle                                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                            â”‚                                         â”‚
â”‚                              ZeroMQ IPC Bus (PUB/SUB)                               â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚                    â”‚                                               â”‚                â”‚
â”‚         UPSTREAM (Events)                              DOWNSTREAM (Commands)        â”‚
â”‚         tcp://127.0.0.1:6010                          tcp://127.0.0.1:6011          â”‚
â”‚                    â”‚                                               â”‚                â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚    â”‚               â”‚               â”‚               â”‚               â”‚          â”‚    â”‚
â”‚    â–¼               â–¼               â–¼               â–¼               â–¼          â–¼    â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚WAKE  â”‚      â”‚ STT  â”‚       â”‚ LLM  â”‚       â”‚ TTS  â”‚       â”‚VISIONâ”‚     â”‚DISPLAYâ”‚  â”‚
â”‚ â”‚WORD  â”‚      â”‚      â”‚       â”‚      â”‚       â”‚      â”‚       â”‚      â”‚     â”‚ + LED â”‚  â”‚
â”‚ â””â”€â”€â”¬â”€â”€â”€â”˜      â””â”€â”€â”¬â”€â”€â”€â”˜       â””â”€â”€â”¬â”€â”€â”€â”˜       â””â”€â”€â”¬â”€â”€â”€â”˜       â””â”€â”€â”¬â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚    â”‚             â”‚              â”‚              â”‚              â”‚                     â”‚
â””â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚             â”‚              â”‚              â”‚              â”‚
     â–¼             â–¼              â–¼              â–¼              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚USB Mic  â”‚  â”‚faster-   â”‚  â”‚Google     â”‚  â”‚Piper TTS â”‚  â”‚Camera     â”‚
â”‚Porcupineâ”‚  â”‚whisper   â”‚  â”‚Gemini API â”‚  â”‚+ aplay   â”‚  â”‚YOLO ONNX  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                              â”‚
                                                              â”‚ Object positions
                                                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                                      â”‚
â”‚                              UART MOTOR BRIDGE                                       â”‚
â”‚                              src/uart/motor_bridge.py                               â”‚
â”‚                                                                                      â”‚
â”‚   Pi-Side Safety Layer:                                                             â”‚
â”‚   if direction == "forward" and last_scan_cm <= 10:                                 â”‚
â”‚       BLOCK MOVEMENT (software safety gate)                                         â”‚
â”‚                                                                                      â”‚
â”‚   /dev/serial0 @ 115200 baud                                                        â”‚
â”‚                                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                               â”‚
                                    UART TX/RX â”‚
                                               â”‚
                                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                                      â”‚
â”‚                              ESP32 MOTOR CONTROLLER                                  â”‚
â”‚                              (esp-code.ino)                                          â”‚
â”‚                                                                                      â”‚
â”‚   Hardware Safety Layer (PRIMARY):                                                  â”‚
â”‚   while(true) {                                                                     â”‚
â”‚       distance = readUltrasonic();                                                  â”‚
â”‚       if (distance < 10cm && moving_forward) {                                      â”‚
â”‚           motors.stop();           â—„â”€â”€ IMMEDIATE HARDWARE STOP                      â”‚
â”‚           Serial.println("ALERT:OBSTACLE");                                         â”‚
â”‚       }                                                                             â”‚
â”‚   }                                                                                 â”‚
â”‚                                                                                      â”‚
â”‚   Motor Drivers: L298N / TB6612                                                     â”‚
â”‚   Sensors: HC-SR04 Ultrasonic                                                       â”‚
â”‚                                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 2.2 Process Hierarchy

```
systemd
â”œâ”€â”€ orchestrator.service          # Central coordinator (MUST run first)
â”‚   â””â”€â”€ python src/core/orchestrator.py
â”‚
â”œâ”€â”€ wakeword.service              # Wake word detection
â”‚   â””â”€â”€ python src/wakeword/porcupine_runner.py
â”‚
â”œâ”€â”€ stt-wrapper.service           # Speech-to-text
â”‚   â””â”€â”€ python src/stt/stt_wrapper_runner.py
â”‚
â”œâ”€â”€ llm.service                   # Language model (Gemini)
â”‚   â””â”€â”€ python src/llm/gemini_runner.py
â”‚
â”œâ”€â”€ tts.service                   # Text-to-speech (Piper)
â”‚   â””â”€â”€ python src/tts/piper_runner.py
â”‚
â”œâ”€â”€ vision.service                # Object detection
â”‚   â””â”€â”€ python src/vision/vision_runner.py
â”‚
â”œâ”€â”€ motor-bridge.service          # UART motor control
â”‚   â””â”€â”€ python src/uart/motor_bridge.py
â”‚
â”œâ”€â”€ display.service               # TFT face display
â”‚   â””â”€â”€ python src/ui/display_runner.py
â”‚
â””â”€â”€ led-ring.service              # NeoPixel status ring
    â””â”€â”€ python src/piled/led_ring_service.py
```

## 2.3 Data Flow Diagram

```
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚   MICROPHONE    â”‚
                                    â”‚   (USB Audio)   â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                             â”‚
                                             â”‚ 44.1kHz PCM
                                             â–¼
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚      ALSA DSNOOP LAYER       â”‚
                              â”‚   (Shared Microphone Access) â”‚
                              â”‚   Device: smartcar_capture   â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                             â”‚
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚                   â”‚                   â”‚
                         â–¼                   â–¼                   â–¼
               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               â”‚   WAKEWORD      â”‚ â”‚   STT SERVICE   â”‚ â”‚  AUDIO MANAGER  â”‚
               â”‚   SERVICE       â”‚ â”‚                 â”‚ â”‚   (Optional)    â”‚
               â”‚                 â”‚ â”‚  Resamples to   â”‚ â”‚                 â”‚
               â”‚  512 samples    â”‚ â”‚  16kHz for      â”‚ â”‚  Ring buffer    â”‚
               â”‚  @ 16kHz        â”‚ â”‚  Whisper        â”‚ â”‚  distribution   â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚                   â”‚
                        â”‚ ww.detected       â”‚ stt.transcription
                        â”‚                   â”‚
                        â–¼                   â–¼
               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               â”‚                    ORCHESTRATOR                        â”‚
               â”‚                                                        â”‚
               â”‚  on_wakeword() â”€â”€â–¶ Pause vision, start STT            â”‚
               â”‚  on_stt()      â”€â”€â–¶ Stop STT, send to LLM              â”‚
               â”‚  on_llm()      â”€â”€â–¶ Parse intent, execute action       â”‚
               â”‚  on_visn()     â”€â”€â–¶ Visual servoing (object follow)    â”‚
               â”‚  on_esp()      â”€â”€â–¶ Update obstacle status             â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                           â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                      â”‚                      â”‚
                    â–¼                      â–¼                      â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚   LLM SERVICE   â”‚    â”‚   TTS SERVICE   â”‚    â”‚  NAV COMMANDS   â”‚
          â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚
          â”‚  Gemini API     â”‚    â”‚  Piper + aplay  â”‚    â”‚  nav.command    â”‚
          â”‚  JSON response  â”‚    â”‚  Audio output   â”‚    â”‚  {direction,    â”‚
          â”‚                 â”‚    â”‚                 â”‚    â”‚   speed}        â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                                  â”‚
                                                                  â–¼
                                                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                        â”‚  UART BRIDGE    â”‚
                                                        â”‚                 â”‚
                                                        â”‚  TX: FORWARD:80 â”‚
                                                        â”‚  RX: ACK:FWD    â”‚
                                                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                                  â”‚
                                                                  â–¼
                                                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                        â”‚     ESP32       â”‚
                                                        â”‚  Motor Control  â”‚
                                                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 2.4 Service Dependency Graph

```
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚    orchestrator     â”‚
                              â”‚    (REQUIRED FIRST) â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚              â”‚              â”‚              â”‚              â”‚
           â–¼              â–¼              â–¼              â–¼              â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  wakeword  â”‚ â”‚    stt     â”‚ â”‚    llm     â”‚ â”‚    tts     â”‚ â”‚   vision   â”‚
    â”‚            â”‚ â”‚            â”‚ â”‚            â”‚ â”‚            â”‚ â”‚            â”‚
    â”‚ Depends:   â”‚ â”‚ Depends:   â”‚ â”‚ Depends:   â”‚ â”‚ Depends:   â”‚ â”‚ Depends:   â”‚
    â”‚ -orchestr. â”‚ â”‚ -orchestr. â”‚ â”‚ -orchestr. â”‚ â”‚ -orchestr. â”‚ â”‚ -orchestr. â”‚
    â”‚ -ALSA      â”‚ â”‚ -ALSA      â”‚ â”‚ -Network   â”‚ â”‚ -ALSA out  â”‚ â”‚ -Camera    â”‚
    â”‚ -PV_KEY    â”‚ â”‚            â”‚ â”‚ -GEMINI_KEYâ”‚ â”‚            â”‚ â”‚            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                                            â”‚              â”‚
           â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚
           â”‚              â”‚                             â”‚              â”‚
           â–¼              â–¼                             â–¼              â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                           UART MOTOR BRIDGE                            â”‚
    â”‚                                                                        â”‚
    â”‚  Depends: -orchestrator                                                â”‚
    â”‚           -/dev/serial0 available                                      â”‚
    â”‚           -ESP32 firmware running                                      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  display   â”‚     â”‚  led-ring  â”‚
    â”‚            â”‚     â”‚            â”‚
    â”‚ Depends:   â”‚     â”‚ Depends:   â”‚
    â”‚ -orchestr. â”‚     â”‚ -orchestr. â”‚
    â”‚ -/dev/fb0  â”‚     â”‚ -GPIO12    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

# 3. HARDWARE COMPONENTS

## 3.1 Complete Hardware Block Diagram

```
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚         POWER DISTRIBUTION          â”‚
                                    â”‚                                     â”‚
                                    â”‚   5V 3A (Pi) â”€â”€â”¬â”€â”€ 5V 2A (ESP32)   â”‚
                                    â”‚                â”‚                    â”‚
                                    â”‚   3.3V (GPIO) â”€â”´â”€â”€ 12V (Motors)    â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                     â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                                â”‚                                â”‚
                    â–¼                                â–¼                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       RASPBERRY PI 4          â”‚  â”‚          ESP32                â”‚  â”‚        PERIPHERALS            â”‚
â”‚                               â”‚  â”‚                               â”‚  â”‚                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚      USB PORTS          â”‚  â”‚  â”‚  â”‚      GPIO PINS          â”‚  â”‚  â”‚  â”‚    USB MICROPHONE       â”‚  â”‚
â”‚  â”‚                         â”‚  â”‚  â”‚  â”‚                         â”‚  â”‚  â”‚  â”‚                         â”‚  â”‚
â”‚  â”‚  USB0: Microphone â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”¼â”€â”€â”¼â”€â”€â”¤                         â”‚  â”‚  â”‚  â”‚  Device: hw:3,0         â”‚  â”‚
â”‚  â”‚  USB1: Camera â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”¼â”€â”€â”¼â”€â”€â”¤                         â”‚  â”‚  â”‚  â”‚  Rate: 44.1kHz/48kHz    â”‚  â”‚
â”‚  â”‚  USB2: (available)      â”‚  â”‚  â”‚  â”‚  GPIO2 â—„â”€â”€ TRIG (HC-SR04)â”‚  â”‚  â”‚  â”‚  Channels: 1 (mono)     â”‚  â”‚
â”‚  â”‚  USB3: (available)      â”‚  â”‚  â”‚  â”‚  GPIO4 â”€â”€â–¶ ECHO          â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â”‚                         â”‚  â”‚  â”‚                               â”‚
â”‚                               â”‚  â”‚  â”‚  GPIO12 â”€â”€â–¶ IN1 (Motor A)â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”‚  GPIO13 â”€â”€â–¶ IN2          â”‚  â”‚  â”‚  â”‚    USB CAMERA           â”‚  â”‚
â”‚  â”‚      GPIO HEADER        â”‚  â”‚  â”‚  â”‚  GPIO14 â”€â”€â–¶ IN3 (Motor B)â”‚  â”‚  â”‚  â”‚                         â”‚  â”‚
â”‚  â”‚                         â”‚  â”‚  â”‚  â”‚  GPIO15 â”€â”€â–¶ IN4          â”‚  â”‚  â”‚  â”‚  Device: /dev/video0    â”‚  â”‚
â”‚  â”‚  GPIO12 â”€â”€â–¶ NeoPixel DINâ”‚  â”‚  â”‚  â”‚                         â”‚  â”‚  â”‚  â”‚  Resolution: 640x480    â”‚  â”‚
â”‚  â”‚  GPIO14 (TXD) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”¼â”€â”€â”¼â”€â”€â”¤â—„â”€â”€ RX (UART)            â”‚  â”‚  â”‚  â”‚  FPS: 30                â”‚  â”‚
â”‚  â”‚  GPIO15 (RXD) â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”¼â”€â”€â”¼â”€â”€â”¤â”€â”€â–¶ TX                   â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”‚                         â”‚  â”‚  â”‚  â”‚                         â”‚  â”‚  â”‚                               â”‚
â”‚  â”‚  SPI0 (for TFT):        â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚    MOSI â”€â”€â–¶ TFT DIN     â”‚  â”‚  â”‚                               â”‚  â”‚  â”‚    WAVESHARE 3.5" TFT   â”‚  â”‚
â”‚  â”‚    SCLK â”€â”€â–¶ TFT CLK     â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”‚                         â”‚  â”‚
â”‚  â”‚    CE0  â”€â”€â–¶ TFT CS      â”‚  â”‚  â”‚  â”‚    MOTOR DRIVER         â”‚  â”‚  â”‚  â”‚  Interface: SPI + FB    â”‚  â”‚
â”‚  â”‚    GPIO24 â”€â”€â–¶ TFT DC    â”‚  â”‚  â”‚  â”‚    (L298N / TB6612)     â”‚  â”‚  â”‚  â”‚  Resolution: 480x320    â”‚  â”‚
â”‚  â”‚    GPIO25 â”€â”€â–¶ TFT RST   â”‚  â”‚  â”‚  â”‚                         â”‚  â”‚  â”‚  â”‚  Color: RGB565 (16-bit) â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â”‚  Motor A (Left):        â”‚  â”‚  â”‚  â”‚  Device: /dev/fb0       â”‚  â”‚
â”‚                               â”‚  â”‚  â”‚    IN1, IN2, ENA        â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”‚  Motor B (Right):       â”‚  â”‚  â”‚                               â”‚
â”‚  â”‚   FRAMEBUFFER           â”‚  â”‚  â”‚  â”‚    IN3, IN4, ENB        â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                         â”‚  â”‚  â”‚  â”‚                         â”‚  â”‚  â”‚  â”‚    NEOPIXEL RING        â”‚  â”‚
â”‚  â”‚  /dev/fb0 â”€â”€â–¶ TFT       â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â”‚                         â”‚  â”‚
â”‚  â”‚  480x320 @ 16bpp        â”‚  â”‚  â”‚                               â”‚  â”‚  â”‚  Pixels: 8              â”‚  â”‚
â”‚  â”‚  RGB565 format          â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”‚  GPIO: D12              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â”‚    ULTRASONIC SENSOR    â”‚  â”‚  â”‚  â”‚  Order: GRB             â”‚  â”‚
â”‚                               â”‚  â”‚  â”‚    (HC-SR04)            â”‚  â”‚  â”‚  â”‚  Voltage: 5V            â”‚  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚                         â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                                   â”‚  â”‚  Range: 2cm - 400cm     â”‚  â”‚  â”‚                               â”‚
                                   â”‚  â”‚  Accuracy: Â±3mm         â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 3.2 Pin Mapping Reference

### Raspberry Pi 4 GPIO Pinout

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚         RASPBERRY PI 4 GPIO         â”‚
                    â”‚              (40-pin)               â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

        3.3V  (1) â—â”€â”€â”¬â”€â”€â— (2)  5V           â—„â”€â”€ NeoPixel VCC
       GPIO2  (3) â—â”€â”€â”¤  â— (4)  5V
       GPIO3  (5) â—â”€â”€â”¤  â— (6)  GND          â—„â”€â”€ NeoPixel GND
       GPIO4  (7) â—â”€â”€â”¤  â— (8)  GPIO14 (TXD) â—„â”€â”€ UART TX to ESP32
         GND  (9) â—â”€â”€â”¤  â— (10) GPIO15 (RXD) â—„â”€â”€ UART RX from ESP32
      GPIO17 (11) â—â”€â”€â”¤  â— (12) GPIO18 (PCM_CLK)
      GPIO27 (13) â—â”€â”€â”¤  â— (14) GND
      GPIO22 (15) â—â”€â”€â”¤  â— (16) GPIO23
        3.3V (17) â—â”€â”€â”¤  â— (18) GPIO24       â—„â”€â”€ TFT DC (Data/Command)
 GPIO10/MOSI (19) â—â”€â”€â”¤  â— (20) GND
  GPIO9/MISO (21) â—â”€â”€â”¤  â— (22) GPIO25       â—„â”€â”€ TFT RST (Reset)
 GPIO11/SCLK (23) â—â”€â”€â”¤  â— (24) GPIO8 (CE0)  â—„â”€â”€ TFT CS (Chip Select)
         GND (25) â—â”€â”€â”¤  â— (26) GPIO7 (CE1)
      GPIO0  (27) â—â”€â”€â”¤  â— (28) GPIO1
       GPIO5 (29) â—â”€â”€â”¤  â— (30) GND
       GPIO6 (31) â—â”€â”€â”¤  â— (32) GPIO12 (PWM0) â—„â”€â”€ NeoPixel DIN
      GPIO13 (33) â—â”€â”€â”¤  â— (34) GND
      GPIO19 (35) â—â”€â”€â”¤  â— (36) GPIO16
      GPIO26 (37) â—â”€â”€â”¤  â— (38) GPIO20
         GND (39) â—â”€â”€â”´â”€â”€â— (40) GPIO21

    Legend:
    â— Used pins
    â—‹ Available pins
```

### ESP32 Pin Configuration

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ESP32 DevKit                            â”‚
â”‚                                                                â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚                                                      â”‚    â”‚
â”‚   â”‚  GPIO2  â”€â”€â–¶ Ultrasonic TRIG                         â”‚    â”‚
â”‚   â”‚  GPIO4  â—€â”€â”€ Ultrasonic ECHO                         â”‚    â”‚
â”‚   â”‚                                                      â”‚    â”‚
â”‚   â”‚  GPIO12 â”€â”€â–¶ Motor A IN1 (Left Forward)              â”‚    â”‚
â”‚   â”‚  GPIO13 â”€â”€â–¶ Motor A IN2 (Left Backward)             â”‚    â”‚
â”‚   â”‚  GPIO14 â”€â”€â–¶ Motor B IN3 (Right Forward)             â”‚    â”‚
â”‚   â”‚  GPIO15 â”€â”€â–¶ Motor B IN4 (Right Backward)            â”‚    â”‚
â”‚   â”‚                                                      â”‚    â”‚
â”‚   â”‚  GPIO16 (RX2) â—€â”€â”€ Pi TX (GPIO14)                    â”‚    â”‚
â”‚   â”‚  GPIO17 (TX2) â”€â”€â–¶ Pi RX (GPIO15)                    â”‚    â”‚
â”‚   â”‚                                                      â”‚    â”‚
â”‚   â”‚  GPIO25 â”€â”€â–¶ Motor A Enable (PWM)                    â”‚    â”‚
â”‚   â”‚  GPIO26 â”€â”€â–¶ Motor B Enable (PWM)                    â”‚    â”‚
â”‚   â”‚                                                      â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                â”‚
â”‚   UART Configuration:                                          â”‚
â”‚   - Baud Rate: 115200                                          â”‚
â”‚   - Data Bits: 8                                               â”‚
â”‚   - Stop Bits: 1                                               â”‚
â”‚   - Parity: None                                               â”‚
â”‚   - Flow Control: None                                         â”‚
â”‚                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 3.3 Audio Hardware Configuration

### ALSA Device Topology

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              ALSA AUDIO STACK                                    â”‚
â”‚                                                                                  â”‚
â”‚  Physical Hardware Layer                                                         â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                         â”‚
â”‚                                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Card 3: USB Audio Device                                                â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ Device 0: USB Audio (capture)    hw:3,0                            â”‚   â”‚
â”‚  â”‚  â””â”€â”€ Device 0: USB Audio (playback)   hw:3,0                            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                  â”‚
â”‚  ALSA Plugin Layer (/etc/asound.conf)                                           â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                          â”‚
â”‚                                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                                          â”‚   â”‚
â”‚  â”‚  pcm.smartcar_capture {         â—„â”€â”€ SHARED MICROPHONE (dsnoop)          â”‚   â”‚
â”‚  â”‚      type dsnoop                                                         â”‚   â”‚
â”‚  â”‚      ipc_key 2048                                                        â”‚   â”‚
â”‚  â”‚      slave {                                                             â”‚   â”‚
â”‚  â”‚          pcm "hw:3,0"                                                    â”‚   â”‚
â”‚  â”‚          channels 1                                                      â”‚   â”‚
â”‚  â”‚          rate 16000             â—„â”€â”€ Native rate for Porcupine           â”‚   â”‚
â”‚  â”‚          format S16_LE                                                   â”‚   â”‚
â”‚  â”‚      }                                                                   â”‚   â”‚
â”‚  â”‚  }                                                                       â”‚   â”‚
â”‚  â”‚                                                                          â”‚   â”‚
â”‚  â”‚  pcm.smartcar_playback {        â—„â”€â”€ SHARED SPEAKER (dmix)               â”‚   â”‚
â”‚  â”‚      type dmix                                                           â”‚   â”‚
â”‚  â”‚      ipc_key 2049                                                        â”‚   â”‚
â”‚  â”‚      slave {                                                             â”‚   â”‚
â”‚  â”‚          pcm "hw:0,0"                                                    â”‚   â”‚
â”‚  â”‚          channels 2                                                      â”‚   â”‚
â”‚  â”‚          rate 48000                                                      â”‚   â”‚
â”‚  â”‚          format S16_LE                                                   â”‚   â”‚
â”‚  â”‚      }                                                                   â”‚   â”‚
â”‚  â”‚  }                                                                       â”‚   â”‚
â”‚  â”‚                                                                          â”‚   â”‚
â”‚  â”‚  pcm.smartcar {                 â—„â”€â”€ COMBINED DEVICE                     â”‚   â”‚
â”‚  â”‚      type asym                                                           â”‚   â”‚
â”‚  â”‚      playback.pcm "smartcar_playback"                                    â”‚   â”‚
â”‚  â”‚      capture.pcm "smartcar_capture"                                      â”‚   â”‚
â”‚  â”‚  }                                                                       â”‚   â”‚
â”‚  â”‚                                                                          â”‚   â”‚
â”‚  â”‚  pcm.!default pcm.smartcar      â—„â”€â”€ DEFAULT DEVICE                      â”‚   â”‚
â”‚  â”‚                                                                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                  â”‚
â”‚  Application Layer (Multiple Simultaneous Readers)                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                              â”‚
â”‚                                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚   Wakeword    â”‚  â”‚     STT       â”‚  â”‚ Audio Manager â”‚                       â”‚
â”‚  â”‚   Service     â”‚  â”‚   Service     â”‚  â”‚  (optional)   â”‚                       â”‚
â”‚  â”‚               â”‚  â”‚               â”‚  â”‚               â”‚                       â”‚
â”‚  â”‚  Opens:       â”‚  â”‚  Opens:       â”‚  â”‚  Opens:       â”‚                       â”‚
â”‚  â”‚  smartcar_    â”‚  â”‚  smartcar_    â”‚  â”‚  smartcar_    â”‚                       â”‚
â”‚  â”‚  capture      â”‚  â”‚  capture      â”‚  â”‚  capture      â”‚                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚         â”‚                  â”‚                  â”‚                                  â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                  â”‚
â”‚                            â”‚                                                     â”‚
â”‚                            â–¼                                                     â”‚
â”‚                   All share the SAME                                             â”‚
â”‚                   physical microphone                                            â”‚
â”‚                   via dsnoop IPC                                                 â”‚
â”‚                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**[STEP 1 COMPLETE - Document continues in next file]**

